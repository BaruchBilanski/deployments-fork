apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  name: kube-enforcer-admission-hook-config
  namespace: aqua
webhooks:
  - name: imageassurance.aquasec.com
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: ["*"]
        apiVersions: ["*"]
        resources: ["pods", "deployments", "replicasets", "replicationcontrollers", "statefulsets", "daemonsets", "jobs", "cronjobs"]
    clientConfig:
      # Please follow instruction in document to generate new CA cert
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZEekNDQXZlZ0F3SUJBZ0lVVHJiVlpIeGEvUnN6YTFZbDFTdVNzZnJEOWVBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0Z6RVZNQk1HQTFVRUF3d01ZV1J0YVhOemFXOXVYMk5oTUI0WERUSXdNRGt5T1RBNE1EYzBNMW9YRFRJegpNRGN5TURBNE1EYzBNMW93RnpFVk1CTUdBMVVFQXd3TVlXUnRhWE56YVc5dVgyTmhNSUlDSWpBTkJna3Foa2lHCjl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUFsd2xMVHRUTmIzVnR5bitCNDdMM2VBQ1RWeTZVdjVXbUZZNUkKZVp6VEJFUEZVTGMrVnIwNTM2VWtJS2YrWXlHZkxoUUQvSFdsWTFoVXRMaHpyTnNLTjJXMWZMUVd3bWp3UDREOAprRjBoMEFJQmdGMU0xMnVjNmhIWjIzMTJrb1ZyQUp6aCtqeXBVM3gwWlZIdUxkelpnZUFWcy9OYkpEK0VZUEVVCm1TRkJ5UVRMMG5uamtRWmhTSUsxQnBOMzI5cVRhdmdHT3Y3ZkVZemRsSU9rZ09oUEF2NjhRY285d1FYZE5rYWoKNzhHeE5SWldpS0ZiZEVKdHo2NGVEc0FaWnorSEsxKzZjbkdlV0h2aU5mRkp1MDJITE5McWpydWx0M0Zxc0RYMAp1REs1V1FtSWtmNlBLbGFTa2R3ZWdQVkxESmdWTUVNK2J2ZTZ3RXpQeDlHT1FjRC85S29pRDFzbXBVMDdXVmxFCnkxMGVGOGxhT2dlQlpYU054Y1lwbG16R3BVQW4xT1JCbUNKSU9XMFdzY2JocXdaMUF5Rms1QnRpbXozVTdsWDYKcmhaUFFQT0p2aU1sOVE0MTZOdWEwa29WUmVUQzBuNU5HM09vNTgvcGhhaEdIYXkvMWh1R1Q1T2FnVW9IeWFoawo2MFZlY1NMVWxPYXNSdXVMQjBFTW9PcXYvbkVNV0t1NkprQk1xeEFSMGtWRVUyM1hRb1RMWnhKaHpmenp3YWdYClFWMDBRNXBhRU9WNThjRjRISkQ4ajBPa1FEbk43YTVZcmJyeTNGSzhpdFJFa2dTTzNWT1JLemt0LzBGNzFUcVUKcnFNNTBOaUJiQnFPeWplT3JIUXBkMHlHbGJqT2xGNXRsTG42YkpCMjRpRjkwY0x1MmQzaCtac1o2NGpTbE1mUQpMMk13V3kwQ0F3RUFBYU5UTUZFd0hRWURWUjBPQkJZRUZCVUROY3NPeTFBNVdpZFMxUnRTZGVRaDVvSWdNQjhHCkExVWRJd1FZTUJhQUZCVUROY3NPeTFBNVdpZFMxUnRTZGVRaDVvSWdNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHcKRFFZSktvWklodmNOQVFFTEJRQURnZ0lCQUQ4Q1RSVFRhWkZFTHh2aFlHSVpsOVZxU2o2M3F3NlN6YjkvdWMvUwpmVjlLekpMUi80cVIwQnhKUVRKNm9INm9GcWZNa216cnJFZHFMdmtaWjVuUjg4Nm5WSTA1Q0lZSFFDbHNTR2NKCitoQWRNWHhReEtFd1R0d3EzWTh6V0w4NDZBOG00T21XM3NvSWlacGx5enBWRXI3UWlOVlJLcGRORU9xWjJyekoKT3JRL242T3I0Q0R4ODJhb1E2czluTlZtWnVCTSsxNmpIOXBzMlJ0QXJ5RUxqd0JrTXNSVHJCQWhwMDJQMjQ2WgpveStGWkRHVlNKYzl0ZitlOVRoV1d4SGNDZ3NYVWljY0JmeGZqdzRtTWdGVEgyUnE3WHNkc1NGbmhEL2NWU0tzCnNUZ1hSdUVBSTVKNzl4SGxHM1J5V1lUS2Q1aWJ0U3ErRkdEY05KeStFcnJXMHlMZVM0SzNQb0RWU2tQWWNNU24KMGQ3UzU0Yk91RG5LNEIxVWEzMUNmekRlYUxtZjVvYjhKOE5GK1ljckE5VFR6Uk9GOVpIUWU5QzFWcHloU2RQSgpUTzdDWC9ONExhZ0Vtc3NINkRVMTVJNnE0bUV2a1p5dnpqcDNldXRhTlJyZ1FNQVJxU2J6a1JEMlN5WFVEMXV2Clk3NzYvaGpVaDVsTS9zM2dBeUVISUJIZDQydzJQL1R2czVBZzFSOXcrak1BcU9aRmpLTmIyTXlCWUpURS91N0sKOE53RDh6Qys5a2JieGwwekJ1VVJGNklQME1hYjN4dWl0cFVPRVBuN2JWYXcwNXhQc1JSRnkyeUpQOG15NHdiVgpHcEx6YmRvRlo4a3FqczNCcU5Zb0pTRTIrSEhFQWRicndpYXJIZk91cjFuVnFaZUZ2THBOWXlCbDRvYXBRNHBRCk1MdzQKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
      service:
        namespace: aqua
        name: aqua-kube-enforcer
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: kube-enforcer-me-injection-hook-config
  namespace: aqua
webhooks:
  - name: microenforcer.aquasec.com
    clientConfig:
      service:
        name: aqua-kube-enforcer
        namespace: aqua
        path: "/mutate"
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZEekNDQXZlZ0F3SUJBZ0lVVHJiVlpIeGEvUnN6YTFZbDFTdVNzZnJEOWVBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0Z6RVZNQk1HQTFVRUF3d01ZV1J0YVhOemFXOXVYMk5oTUI0WERUSXdNRGt5T1RBNE1EYzBNMW9YRFRJegpNRGN5TURBNE1EYzBNMW93RnpFVk1CTUdBMVVFQXd3TVlXUnRhWE56YVc5dVgyTmhNSUlDSWpBTkJna3Foa2lHCjl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUFsd2xMVHRUTmIzVnR5bitCNDdMM2VBQ1RWeTZVdjVXbUZZNUkKZVp6VEJFUEZVTGMrVnIwNTM2VWtJS2YrWXlHZkxoUUQvSFdsWTFoVXRMaHpyTnNLTjJXMWZMUVd3bWp3UDREOAprRjBoMEFJQmdGMU0xMnVjNmhIWjIzMTJrb1ZyQUp6aCtqeXBVM3gwWlZIdUxkelpnZUFWcy9OYkpEK0VZUEVVCm1TRkJ5UVRMMG5uamtRWmhTSUsxQnBOMzI5cVRhdmdHT3Y3ZkVZemRsSU9rZ09oUEF2NjhRY285d1FYZE5rYWoKNzhHeE5SWldpS0ZiZEVKdHo2NGVEc0FaWnorSEsxKzZjbkdlV0h2aU5mRkp1MDJITE5McWpydWx0M0Zxc0RYMAp1REs1V1FtSWtmNlBLbGFTa2R3ZWdQVkxESmdWTUVNK2J2ZTZ3RXpQeDlHT1FjRC85S29pRDFzbXBVMDdXVmxFCnkxMGVGOGxhT2dlQlpYU054Y1lwbG16R3BVQW4xT1JCbUNKSU9XMFdzY2JocXdaMUF5Rms1QnRpbXozVTdsWDYKcmhaUFFQT0p2aU1sOVE0MTZOdWEwa29WUmVUQzBuNU5HM09vNTgvcGhhaEdIYXkvMWh1R1Q1T2FnVW9IeWFoawo2MFZlY1NMVWxPYXNSdXVMQjBFTW9PcXYvbkVNV0t1NkprQk1xeEFSMGtWRVUyM1hRb1RMWnhKaHpmenp3YWdYClFWMDBRNXBhRU9WNThjRjRISkQ4ajBPa1FEbk43YTVZcmJyeTNGSzhpdFJFa2dTTzNWT1JLemt0LzBGNzFUcVUKcnFNNTBOaUJiQnFPeWplT3JIUXBkMHlHbGJqT2xGNXRsTG42YkpCMjRpRjkwY0x1MmQzaCtac1o2NGpTbE1mUQpMMk13V3kwQ0F3RUFBYU5UTUZFd0hRWURWUjBPQkJZRUZCVUROY3NPeTFBNVdpZFMxUnRTZGVRaDVvSWdNQjhHCkExVWRJd1FZTUJhQUZCVUROY3NPeTFBNVdpZFMxUnRTZGVRaDVvSWdNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHcKRFFZSktvWklodmNOQVFFTEJRQURnZ0lCQUQ4Q1RSVFRhWkZFTHh2aFlHSVpsOVZxU2o2M3F3NlN6YjkvdWMvUwpmVjlLekpMUi80cVIwQnhKUVRKNm9INm9GcWZNa216cnJFZHFMdmtaWjVuUjg4Nm5WSTA1Q0lZSFFDbHNTR2NKCitoQWRNWHhReEtFd1R0d3EzWTh6V0w4NDZBOG00T21XM3NvSWlacGx5enBWRXI3UWlOVlJLcGRORU9xWjJyekoKT3JRL242T3I0Q0R4ODJhb1E2czluTlZtWnVCTSsxNmpIOXBzMlJ0QXJ5RUxqd0JrTXNSVHJCQWhwMDJQMjQ2WgpveStGWkRHVlNKYzl0ZitlOVRoV1d4SGNDZ3NYVWljY0JmeGZqdzRtTWdGVEgyUnE3WHNkc1NGbmhEL2NWU0tzCnNUZ1hSdUVBSTVKNzl4SGxHM1J5V1lUS2Q1aWJ0U3ErRkdEY05KeStFcnJXMHlMZVM0SzNQb0RWU2tQWWNNU24KMGQ3UzU0Yk91RG5LNEIxVWEzMUNmekRlYUxtZjVvYjhKOE5GK1ljckE5VFR6Uk9GOVpIUWU5QzFWcHloU2RQSgpUTzdDWC9ONExhZ0Vtc3NINkRVMTVJNnE0bUV2a1p5dnpqcDNldXRhTlJyZ1FNQVJxU2J6a1JEMlN5WFVEMXV2Clk3NzYvaGpVaDVsTS9zM2dBeUVISUJIZDQydzJQL1R2czVBZzFSOXcrak1BcU9aRmpLTmIyTXlCWUpURS91N0sKOE53RDh6Qys5a2JieGwwekJ1VVJGNklQME1hYjN4dWl0cFVPRVBuN2JWYXcwNXhQc1JSRnkyeUpQOG15NHdiVgpHcEx6YmRvRlo4a3FqczNCcU5Zb0pTRTIrSEhFQWRicndpYXJIZk91cjFuVnFaZUZ2THBOWXlCbDRvYXBRNHBRCk1MdzQKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: ["*"]
        apiVersions: ["v1"]
        resources: ["pods"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aqua-kube-enforcer-sa
  namespace: aqua
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: aqua-kube-enforcer
rules:
  - apiGroups: ["*"]
    resources: ["pods", "secrets", "nodes", "namespaces", "deployments", "statefulsets", "jobs", "cronjobs", "daemonsets", "replicasets", "replicationcontrollers", "clusterroles", "clusterrolebindings", "componentstatuses"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: aqua-kube-enforcer
  namespace: aqua
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: aqua-kube-enforcer
subjects:
  - kind: ServiceAccount
    name: aqua-kube-enforcer-sa
    namespace: aqua
---
# This role specific to kube-bench scans permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: aqua-kube-enforcer
  namespace: aqua
rules:
  - apiGroups: ["*"]
    resources: ["pods/log"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["*"]
    resources: ["jobs"]
    verbs: ["create", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: aqua-kube-enforcer
  namespace: aqua
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: aqua-kube-enforcer
subjects:
- kind: ServiceAccount
  name: aqua-kube-enforcer-sa
  namespace: aqua
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: aqua-csp-kube-enforcer
  namespace: aqua
data:
  # Specify whether to enable/disable the cache by using "yes", "true", "no", "false" values.
  # Default value is "yes".
  AQUA_ENABLE_CACHE: "yes"
  # Specify cache expiration period in seconds.
  # Default value is 60
  AQUA_CACHE_EXPIRATION_PERIOD: "60"
  TLS_SERVER_CERT_FILEPATH: "/certs/aqua_ke.crt"
  TLS_SERVER_KEY_FILEPATH: "/certs/aqua_ke.key"
  ## Based on your ingress config update the name here ##
  AQUA_GATEWAY_SECURE_ADDRESS: "aqua-gateway.aqua:8443"
  AQUA_TLS_PORT: "8443"
  # Cluster display name in aqua csp.
  CLUSTER_NAME: "aqua-secure"